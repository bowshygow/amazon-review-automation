generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AmazonOrder {
  id                  String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  amazonOrderId       String          @unique @map("amazon_order_id") @db.VarChar(255)
  purchaseDate        DateTime        @map("purchase_date") @db.Timestamptz(6)
  deliveryDate        DateTime?       @map("delivery_date") @db.Timestamptz(6)
  orderStatus         String          @default("Shipped") @map("order_status") @db.VarChar(50)
  orderTotal          Json            @map("order_total")
  marketplaceId       String          @map("marketplace_id") @db.VarChar(50)
  buyerInfo           Json?           @default("{}") @map("buyer_info")
  items               Json?           @default("[]")
  isReturned          Boolean?        @default(false) @map("is_returned")
  returnDate          DateTime?       @map("return_date") @db.Timestamptz(6)
  reviewRequestSent   Boolean?        @default(false) @map("review_request_sent")
  reviewRequestDate   DateTime?       @map("review_request_date") @db.Timestamptz(6)
  reviewRequestStatus String?         @map("review_request_status") @db.VarChar(50)
  reviewRequestError  String?         @map("review_request_error")
  createdAt           DateTime?       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime?       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  activityLogs        ActivityLog[]
  reviewRequests      ReviewRequest[]

  @@index([amazonOrderId], map: "idx_amazon_orders_amazon_order_id")
  @@index([deliveryDate], map: "idx_amazon_orders_delivery_date")
  @@index([reviewRequestSent], map: "idx_amazon_orders_review_request_sent")
  @@index([isReturned], map: "idx_amazon_orders_is_returned")
  @@index([orderStatus], map: "idx_amazon_orders_order_status")
  @@index([marketplaceId], map: "idx_amazon_orders_marketplace_id")
  @@map("amazon_orders")
}

model ReviewRequest {
  id            String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId       String      @map("order_id") @db.Uuid
  amazonOrderId String      @map("amazon_order_id") @db.VarChar(255)
  status        String      @default("pending") @db.VarChar(50)
  sentAt        DateTime?   @map("sent_at") @db.Timestamptz(6)
  errorMessage  String?     @map("error_message")
  retryCount    Int?        @default(0) @map("retry_count")
  createdAt     DateTime?   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  order         AmazonOrder @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([orderId], map: "idx_review_requests_order_id")
  @@index([amazonOrderId], map: "idx_review_requests_amazon_order_id")
  @@index([status], map: "idx_review_requests_status")
  @@index([createdAt], map: "idx_review_requests_created_at")
  @@map("review_requests")
}

model AmazonApiConfig {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  clientId       String    @map("client_id") @db.VarChar(255)
  clientSecret   String    @map("client_secret") @db.VarChar(255)
  refreshToken   String    @map("refresh_token")
  marketplaceId  String    @map("marketplace_id") @db.VarChar(50)
  accessToken    String?   @map("access_token")
  tokenExpiresAt DateTime? @map("token_expires_at") @db.Timestamptz(6)
  isActive       Boolean?  @default(true) @map("is_active")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("amazon_api_config")
}

model ActivityLog {
  id        String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  action    String       @db.VarChar(100)
  details   Json?        @default("{}")
  orderId   String?      @map("order_id") @db.Uuid
  createdAt DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  order     AmazonOrder? @relation(fields: [orderId], references: [id], onUpdate: NoAction)

  @@index([action], map: "idx_activity_logs_action")
  @@index([orderId], map: "idx_activity_logs_order_id")
  @@index([createdAt], map: "idx_activity_logs_created_at")
  @@map("activity_logs")
}


enum InventoryLedgerStatus {
  WAITING
  CLAIMABLE
  CLAIM_INITIATED
  CLAIMED
  PAID
  INVALID
  RESOLVED
}


model InventoryLedgerEvent {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  eventDate             DateTime @map("event_date")
  fnsku                 String   @db.VarChar(50)
  asin                  String   @db.VarChar(20)
  sku                   String   @db.VarChar(100)
  productTitle          String   @map("product_title") @db.Text
  eventType             String   @map("event_type") @db.VarChar(50)
  referenceId           String?  @map("reference_id") @db.VarChar(100)
  quantity              Int
  fulfillmentCenter     String?  @map("fulfillment_center") @db.VarChar(20)
  disposition           String?  @db.VarChar(50)
  reconciledQuantity    Int      @default(0) @map("reconciled_quantity")
  unreconciledQuantity  Int      @default(0) @map("unreconciled_quantity")
  country               String   @default("US") @db.VarChar(10)
  rawTimestamp          DateTime @map("raw_timestamp") @db.Timestamptz
  storeId               String?  @map("store_id") @db.Uuid
  status                InventoryLedgerStatus @default(WAITING)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Indexes for performance optimization
  @@index([eventDate], name: "idx_inventory_ledger_events_event_date")
  @@index([fnsku], name: "idx_inventory_ledger_events_fnsku")
  @@index([asin], name: "idx_inventory_ledger_events_asin")
  @@index([sku], name: "idx_inventory_ledger_events_sku")
  @@index([eventType], name: "idx_inventory_ledger_events_event_type")
  @@index([status], name: "idx_inventory_ledger_events_status")
  @@index([fulfillmentCenter], name: "idx_inventory_ledger_events_fulfillment_center")
  @@index([unreconciledQuantity], name: "idx_inventory_ledger_events_unreconciled_quantity")
  @@index([rawTimestamp], name: "idx_inventory_ledger_events_raw_timestamp")
  @@index([storeId], name: "idx_inventory_ledger_events_store_id")
  
  // Composite indexes for common queries
  @@index([status, eventDate], name: "idx_inventory_ledger_events_status_event_date")
  @@index([eventType, status], name: "idx_inventory_ledger_events_event_type_status")
  @@index([fnsku, eventDate], name: "idx_inventory_ledger_events_fnsku_event_date")
  
  @@map("inventory_ledger_events")
}