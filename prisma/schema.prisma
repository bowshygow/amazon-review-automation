// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AmazonOrder {
  id                    String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  amazonOrderId        String   @unique @map("amazon_order_id")
  purchaseDate         DateTime @map("purchase_date")
  deliveryDate         DateTime @map("delivery_date")
  orderStatus          String   @default("Shipped") @map("order_status")
  orderTotal           Json     @map("order_total")
  marketplaceId        String   @map("marketplace_id")
  buyerInfo            Json     @default("{}") @map("buyer_info")
  items                Json     @default("[]")
  isReturned           Boolean  @default(false) @map("is_returned")
  returnDate           DateTime? @map("return_date")
  reviewRequestSent    Boolean  @default(false) @map("review_request_sent")
  reviewRequestDate    DateTime? @map("review_request_date")
  reviewRequestStatus  String?  @map("review_request_status")
  reviewRequestError   String?  @map("review_request_error")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  reviewRequests       ReviewRequest[]
  activityLogs         ActivityLog[]

  // Indexes for performance optimization
  @@index([amazonOrderId], name: "idx_amazon_orders_amazon_order_id")
  @@index([deliveryDate], name: "idx_amazon_orders_delivery_date")
  @@index([reviewRequestSent], name: "idx_amazon_orders_review_request_sent")
  @@index([isReturned], name: "idx_amazon_orders_is_returned")
  @@index([orderStatus], name: "idx_amazon_orders_order_status")
  @@index([marketplaceId], name: "idx_amazon_orders_marketplace_id")
  
  @@map("amazon_orders")
}

model ReviewRequest {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orderId         String   @map("order_id") @db.Uuid
  amazonOrderId   String   @map("amazon_order_id")
  status          String   @default("PENDING")
  sentAt          DateTime? @map("sent_at")
  errorMessage    String?  @map("error_message")
  retryCount      Int      @default(0) @map("retry_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  order           AmazonOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([orderId], name: "idx_review_requests_order_id")
  @@index([amazonOrderId], name: "idx_review_requests_amazon_order_id")
  @@index([status], name: "idx_review_requests_status")
  @@index([createdAt], name: "idx_review_requests_created_at")
  
  @@map("review_requests")
}

model AmazonApiConfig {
  id            String   @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  clientId      String   @unique @map("client_id") @db.VarChar(255)
  clientSecret  String   @map("client_secret") @db.VarChar(255)
  refreshToken  String   @map("refresh_token") @db.Text
  marketplaceId String   @map("marketplace_id") @db.VarChar(50)
  accessToken   String?  @map("access_token") @db.Text
  tokenExpiresAt DateTime? @map("token_expires_at") @db.Timestamptz
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz
  
  @@map("amazon_api_config")
}

model ActivityLog {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  action    String
  details   Json     @default("{}")
  orderId   String?  @map("order_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  order     AmazonOrder? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Indexes for performance and audit
  @@index([action], name: "idx_activity_logs_action")
  @@index([orderId], name: "idx_activity_logs_order_id")
  @@index([createdAt], name: "idx_activity_logs_created_at")
  
  @@map("activity_logs")
}
